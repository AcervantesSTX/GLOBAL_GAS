C2

GLOBAL_GAS.BE:C2.COMMAND.CAT.EMPLEADOS
  REPLICAR ()
    IF GLOBAL_GAS.BE:C2.LIBRARY.GLOBALNET.DESCARGAR_EMPLEADOS
      GLOBAL_GAS.BE:C3.STEP.CAT_EMPLEADOS.ELIMINAR_TODOS
      FOREACH
        GLOBAL_GAS.BE:C3.STEP.CAT.EMPLEADOS.AGREGAR

GLOBAL_GAS.BE:C2.COMMAND.CAT.UNIDADES
  REPLICAR ()
    IF GLOBAL_GAS.BE:C2.LIBRARY.GLOBALNET.DESCARGAR_UNIDADES
      GLOBAL_GAS.BE:C3.STEP.CAT_UNIDADES.ELIMINAR_TODAS
      FOREACH
        GLOBAL_GAS.BE:C3.STEP.CAT.UNIDADES.AGREGAR

GLOBAL_GAS.BE:C2.COMMAND.OPE.SESION
  INICIAR (EMPLEADO, APIKEY) *DEVOLVER JWT
    NEW EMPLEADO
    EMPLEADO.VALIDAR_APIKEY
    GLOBAL_GAS.BE:C3.STEP.OPE.SESION.INICIAR
  DEPURAR ()
    GLOBAL_GAS.BE:C3.STEP.OPE.SESION.DEPURAR

GLOBAL_GAS.BE:C2.COMMAND.OPE.SINCRONIZACION_APLICACION
  CARGAR (DETALLES)
    FOREACH
      SWITCH TIPO
        CASE SERVICIOS.EN_PROCESO *DETALLE {TIPO, ID_GLOBALNET, FECHAHORA}
          NEW SERVICIO
          SERVICIO.VALIDAR_PROPIETARIO
          FECHAHORA ES HOY
          GLOBAL_GAS.BE:C3.STEP.OPE.SERVICIOS.EN_PROCESO
        CASE SERVICIOS.CANCELAR *DETALLE {TIPO, ID_GLOBALNET, FECHAHORA, RAZON_CANCELACION}
          NEW SERVICIO
          SERVICIO.VALIDAR_PROPIETARIO
          FECHAHORA ES HOY
          GLOBAL_GAS.BE:C3.STEP.OPE.SERVICIOS.CANCELAR
        CASE NOTAS.AGREGAR *DETALLE {TIPO, FECHAHORA, CLIENTE, CUENTA, FOLIO, MONTO, TIPO_PAGO, DESCUENTO, LATITUD, LONGITUD, REFERENCIA: {CANTIDAD_10, CANTIDAD_20, CANTIDAD_30, CANTIDAD_45, CANTIDAD_KILOS, PRECIO_10, PRECIO_20, PRECIO_30, PRECIO_45, PRECIO_KILOS} {LITROS, PRECIO}, ID_GLOBALNET_SERVICIO, ID_GLOBALNET_CUENTA_OCULTA}
          FECHAHORA ES HOY
          IF ID_GLOBALNET_SERVICIO
            NEW SERVICIO
            SERVICIO.VALIDAR_PROPIETARIO
            SERVICIO.VALIDAR_CLIENTE
            SERVICIO.VALIDAR_CUENTA
          IF ID_GLOBALNET_CUENTA_OCULTA
            NEW CUENTA_OCULTA
            CUENTA_OCULTA.VALIDAR_PROPIETARIO
            CUENTA_OCULTA.VALIDAR_DISPONIBLE
          GLOBAL_GAS.BE:C3.STEP.OPE.NOTAS.AGREGAR

GLOBAL_GAS.BE:C2.COMMAND.OPE.COLA_APLICACION
  DEPURAR ()
    GLOBAL_GAS.BE:C3.STEP.OPE.COLA_APLICACION.DEPURAR

GLOBAL_GAS.BE:C2.COMMAND.OPE.LIQUIDACIONES
  ASIGNAR_INICIAL_ESTACIONARIO (ID_GLOBALNET_UNIDAD, FECHAHORA, MEDIDOR_INICIAL, ROTOGAUGE_INICIAL)
    SESION.EMPLEADO.VALIDAR_SUPERVISOR
    NEW UNIDAD
    FECHAHORA ES HOY
    GLOBAL_GAS.BE:C3.STEP.OPE.LIQUIDACIONES.ASIGNAR_INICIAL_ESTACIONARIO
  ASIGNAR_FINAL_ESTACIONARIO (ID_GLOBALNET_UNIDAD, FECHAHORA, MEDIDOR_FINAL, ROTOGAUGE_FINAL)
    SESION.EMPLEADO.VALIDAR_SUPERVISOR
    NEW UNIDAD
    FECHAHORA ES HOY
    GLOBAL_GAS.BE:C3.STEP.OPE.LIQUIDACIONES.ASIGNAR_FINAL_ESTACIONARIO
  VALIDAR_INICIAL_CILINDRO (ID_GLOBALNET_UNIDAD, FECHAHORA)
    SESION.EMPLEADO.VALIDAR_SUPERVISOR
    NEW UNIDAD
    FECHAHORA ES HOY
    GLOBAL_GAS.BE:C3.STEP.OPE.LIQUIDACIONES.VALIDAR_INICIAL_CILINDRO
  VALIDAR_FINAL_CILINDRO (ID_GLOBALNET_UNIDAD, FECHAHORA)
    SESION.EMPLEADO.VALIDAR_SUPERVISOR
    NEW UNIDAD
    FECHAHORA ES HOY
    GLOBAL_GAS.BE:C3.STEP.OPE.LIQUIDACIONES.VALIDAR_FINAL_CILINDRO

GLOBAL_GAS.BE:C2.COMMAND.OPE.SINCRONIZACION_GLOBALNET
  INICIAR_AGENTE_DESCARGA (INSTANCIA)
    IF NOT AGENTE EN EJECUCION
      SHELL_EXEC GLOBAL_GAS.BE:C1.ACTION.OPE.SINCRONIZACION_GLOBALNET.EJECUTAR_AGENTE_DESCARGA
  INICIAR_AGENTE_CARGA (INSTANCIA)
    IF NOT AGENTE EN EJECUCION
      SHELL_EXEC GLOBAL_GAS.BE:C1.ACTION.OPE.SINCRONIZACION_GLOBALNET.EJECUTAR_AGENTE_CARGA
  EJECUTAR_AGENTE_DESCARGA ()
    WHILE TRUE
      IF GLOBAL_GAS.BE:C2.LIBRARY.GLOBALNET.DESCARGAR_SINCRONIZACION
        FOREACH
          SWITCH TIPO
            CASE EMPLEADOS.AGREGAR
              GLOBAL_GAS.BE:C3.STEP.CAT.EMPLEADOS.AGREGAR
            CASE EMPLEADOS.ACTUALIZAR
              GLOBAL_GAS.BE:C3.STEP.CAT.EMPLEADOS.ACTUALIZAR
            CASE UNIDADES.AGREGAR
              GLOBAL_GAS.BE:C3.STEP.CAT.UNIDADES.AGREGAR
            CASE UNIDADES.ACTUALIZAR
              GLOBAL_GAS.BE:C3.STEP.CAT.UNIDADES.ACTUALIZAR
            CASE PRECIOS.AGREGAR
              GLOBAL_GAS.BE:C3.STEP.CAT.PRECIOS.AGREGAR
            CASE PRECIOS.ACTUALIZAR
              GLOBAL_GAS.BE:C3.STEP.CAT.PRECIOS.ACTUALIZAR
            CASE SERVICIOS.AGREGAR
              GLOBAL_GAS.BE:C3.STEP.OPE.SERVICIOS.AGREGAR
            CASE SERVICIOS.ACTUALIZAR
              GLOBAL_GAS.BE:C3.STEP.OPE.SERVICIOS.ACTUALIZAR
            CASE CUENTAS_OCULTAS.AGREGAR
              GLOBAL_GAS.BE:C3.STEP.OPE.CUENTAS_OCULTAS.AGREGAR
      GLOBAL_GAS.BE:C3.STEP.OPE.CONF_GENERAL.ACTUALIZAR_SINCRONIZACION_GLOBALNET_FECHA_DESCARGA
      SLEEP
  EJECUTAR_AGENTE_CARGA ()
    WHILE TRUE
      IF EXTRACT
        TRANSFORM
        GLOBAL_GAS.BE:C3.STEP.OPE.GLOBALNET.CARGAR_SINCRONIZACION
      SLEEP

GLOBAL_GAS.BE:C2.COMMAND.CON.EMPLEADOS
  OBTENER_APIKEY (EMPLEADO, CONTRASENA) *DEVUELVE APIKEY
    NEW EMPLEADO
    EMPLEADO.VALIDAR_CONTRASENA
    RETURN
  CONSULTAR () *DEVUELVE NOMBRE, NUMERO, TELEFONO, IMAGEN
    EXTRACT
    TRANSFORM
    RETURN

GLOBAL_GAS.BE:C2.COMMAND.CON.UNIDADES
  CONSULTAR () *DEVUELVE ID_GLOBALNET, NUMERO_ECONOMICO, TIPO_UNIDAD
    EXTRACT
    TRANSFORM
    RETURN

GLOBAL_GAS.BE:C2.COMMAND.CON.SINCRONIZACION_APLICACION
  DESCARGAR (A_PARTIR_DE) *DEVUELVE DETALLE
    EXTRACT *SOLO LO DE LA UNIDAD DEL EMPLEADO EN SESION Y LO DE LA UNIDAD CERO
    TRANSFORM
    RETURN

GLOBAL_GAS.BE: C2.COMMAND.CON.LIQUIDACIONES
  CONSULTAR (ID_GLOBALNET_UNIDAD) *SI ENCUENTRA LIQUIDACION ABIERTA DEVUELVE MEDIDOR_INICIAL Y ROTOGAUGE_INICIAL (ESTACIONARIO), DEVUELVE DOTACION Y DOTACION MENOS NOTAS (CILINDRO), SI NO ENCUENTRA LIQUIDACION ABIERTA DEVUELVE CUENTALITROS Y ROTOGAUGE DE LA UNIDAD (ESTACIONARIO), DEVUELVE DOTACION (CILINDRO)
    EXTRACT
    TRANSFORM
    RETURN